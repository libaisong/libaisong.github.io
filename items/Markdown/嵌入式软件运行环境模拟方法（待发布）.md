# 嵌入式软件运行环境模拟方法

嵌入式软件运行在嵌入式设备的主控芯片中，如MCU、MPU等，如果要在PC上进行软件在环（Software In the Loop, SIL）仿真，需要模拟一个嵌入式软件的运行环境，以保证仿真结果和实际运行的结果一致。嵌入式软件运行环境模拟的重点在于如何在PC中产生主控芯片的各个中断，有了中断之后，就有了嵌入式软件的运行环境，在对应中断中执行相应的软件任务，就可以实现嵌入式软件的仿真。  

## 1. 嵌入式软件工作流程
嵌入式软件可以划分为多个软件任务，可以根据任务优先级以及执行的快慢程度进行划分，比如电流环控制可以放在PWM中断中执行，速度环控制可以放在1ms任务中执行，而参数读写因为优先级低且对运行速度要求不高，可以放在后台任务中执行。通过合理设置主控芯片的外设，使其按照预定的周期触发中断事件，然后将各个任务放到对应中断中执行，就可以使嵌入式软件运行起来，如下图所示。  

```mermaid
graph
direction LR
    subgraph 其它中断
    direction TB 
        其它外设中断 --> 其它任务 --> 其它中断结束
    end

    subgraph PWM中断
    direction TB 
        PWM定时器中断 --> PWM任务 --> PWM中断结束
    end

    subgraph 1ms中断
    direction TB
        1ms定时器中断 --> 1ms任务 --> 1ms中断结束
    end

    subgraph 后台
    direction TB
        上电 --> A[初始化]
        A --> B[后台任务]
        B --> B
    end
```

## 2. 嵌入式软件运行环境模拟
嵌入式软件要想在PC中运行起来，就需要在PC中模拟各个外设中断的情况，本文给出一种模拟的方法。假设主控芯片时钟频率为1Mhz，仿真时间为10s，那么可以建立一个执行$10^7$次的循环，那么每循环一次代表时间增加1us，如果一个中断任务的执行周期为1ms，那么每循环1000次就可以执行一次该任务，为了简化可以将后台任务设置为一个固定周期（比如2ms），整个流程如下图所示。  

```mermaid
graph TB

    subgraph 其它任务
        direction LR 
        B5{执行其它任务？}
        B5 -->|是| C5[执行其它任务];
        B5 -->|否| E5[其它任务结束];
        C5 --> E5;
    end

    subgraph PWM任务
        direction LR 
        B4{执行PWM任务？}
        B4 -->|是| C4[执行PWM任务];
        B4 -->|否| E4[PWM任务结束];
        C4 --> E4;
    end

    subgraph 1ms任务
        direction LR 
        B3{执行1ms任务？}
        B3 -->|是| C3[执行1ms任务];
        B3 -->|否| E3[1ms任务结束];
        C3 --> E3;
    end

    subgraph 后台任务
        direction LR 
        B2{执行后台任务？}
        B2 -->|是| C2[执行后台任务];
        B2 -->|否| E2[后台任务结束];
        C2 --> E2;
    end

    上电 --> A[初始化]
    A --> 后台任务
    后台任务 --> 1ms任务
    1ms任务 --> PWM任务
    PWM任务 --> 其它任务
    其它任务 --循环次数加1--> H{达到最大循环次数？}
    H -->|否| 后台任务
    H -->|是| 结束
    
```

仿真精度和运算效率是判断嵌入式软件环境模拟效果好坏的重要标准。具体实现过程本文不再展开。